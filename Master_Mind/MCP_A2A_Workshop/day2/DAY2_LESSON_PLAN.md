# Day 2: Agent2Agent â€” Collaborative Intelligence

**Date:** December 17, 2025  
**Time:** 9:00 AM - 12:00 PM (3 hours)  
**Format:** 3 sessions Ã— 45 minutes + breaks

---

## Workshop Overview

Day 2 builds on the MCP servers from Day 1 to explore agent-to-agent collaboration. We introduce the A2A protocol, build an A2A agent that wraps our existing MCP infrastructure, and orchestrate multi-agent workflows using N8N.

**Prerequisites:**
- Completed Day 1 (MCP servers built and tested)
- Docker installed (Docker Desktop on Mac)

---

## Supplemental Content

> **ğŸ“º A2A Deep Dive Video**  
> A comprehensive video covering the A2A protocol specification in detail will be uploaded to the IIoT University portal after this session. Topics include:
> - Complete A2A protocol specification walkthrough
> - JSON-RPC vs gRPC vs HTTP+JSON bindings
> - Advanced task lifecycle patterns
> - Push notifications and streaming
> - Security schemes and authentication
> - Agent-to-agent delegation patterns
> - Enterprise deployment patterns

---

## Session Schedule

| Session | Time | Topic |
|---------|------|-------|
| 1 | 9:00 - 9:45 | Day 1 Review, A2A Introduction & Environment Setup |
| â€” | 9:45 - 10:00 | Break |
| 2 | 10:00 - 10:45 | Building Your First A2A Agent |
| â€” | 10:45 - 11:00 | Break |
| 3 | 11:00 - 11:45 | Multi-Agent Workflows with N8N |

---

# Session 1: Day 1 Review, A2A Introduction & Environment Setup
**Time:** 9:00 - 9:45 (45 minutes)

## Goals

- Review Day 1 MCP server architecture and what we built
- Understand why agent-to-agent communication matters
- Learn the A2A protocol fundamentals
- Install Portainer and N8N for later sessions

---

## 1.1 Day 1 Review â€” What We Built

- **MQTT MCP Server** â€” connects Claude to the Unified Namespace
- **MySQL MCP Server** â€” connects Claude to relational MES data
- **MES Domain Server** â€” combines both into Press 103-focused tools
- **Key pattern** â€” MCP gives agents access to tools and data sources
- **Result** â€” Claude can answer questions about Press 103 using natural language

---

## 1.2 The Limitation of Single-Agent Systems

- One agent, one set of tools, one perspective
- Complex problems require multiple areas of expertise
- Production issues span equipment, quality, maintenance, scheduling
- How do specialized agents collaborate?
- This is the problem A2A solves

---

## 1.3 MCP vs A2A â€” Different Problems, Complementary Solutions

| Aspect | MCP | A2A |
|--------|-----|-----|
| **Purpose** | Agent to tools/data | Agent to agent |
| **Connection** | Agent â†” Infrastructure | Agent â†” Agent |
| **Question** | "What can I access?" | "Who can help me?" |
| **Day 1** | Built MCP servers | â€” |
| **Day 2** | â€” | Building A2A agents |

- MCP is the foundation â€” agents need data access
- A2A builds on top â€” agents collaborate using their MCP tools
- Together they enable industrial AI systems

---

## 1.4 The A2A Protocol â€” Overview

- **Origin** â€” Google DeepMind, now Linux Foundation open standard
- **Purpose** â€” Enable AI agents to discover, communicate, and collaborate
- **Transport** â€” Built on HTTP, JSON-RPC 2.0, Server-Sent Events

### Core Concepts

| Concept | Description |
|---------|-------------|
| **Agent Card** | JSON metadata describing identity and capabilities |
| **Tasks** | Fundamental unit of work with lifecycle states |
| **Messages** | Communication turns between agents |
| **Artifacts** | Outputs generated by tasks (data, documents, results) |
| **Skills** | Discrete capabilities an agent can perform |

### Task Lifecycle States

```
submitted â†’ working â†’ completed
                   â†’ failed
                   â†’ cancelled
                   â†’ input_required (needs more info)
                   â†’ rejected (can't handle)
```

---

## 1.5 How A2A Works â€” The Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client         â”‚                      â”‚  A2A Agent      â”‚
â”‚                 â”‚                      â”‚                 â”‚
â”‚  1. Discover    â”‚â”€â”€â”€GET agent.jsonâ”€â”€â”€â”€â–¶â”‚  Agent Card     â”‚
â”‚                 â”‚â—€â”€â”€capabilitiesâ”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
â”‚                 â”‚                      â”‚                 â”‚
â”‚  2. Send Task   â”‚â”€â”€â”€POST /message/sendâ”€â–¶â”‚  Process Task   â”‚
â”‚                 â”‚â—€â”€â”€task + artifactsâ”€â”€â”€â”‚                 â”‚
â”‚                 â”‚                      â”‚                 â”‚
â”‚  3. Get Results â”‚â”€â”€â”€GET /tasks/{id}â”€â”€â”€â–¶â”‚  Return Results â”‚
â”‚                 â”‚â—€â”€â”€artifactsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1.6 Environment Setup â€” Installing Portainer and N8N

### Verify Docker is Running

```bash
docker --version
docker ps
```

### Install Portainer

```bash
# Create volume for Portainer data
docker volume create portainer_data

# Run Portainer container
docker run -d \
  --name portainer \
  --restart=always \
  -p 9000:9000 \
  -p 9443:9443 \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v portainer_data:/data \
  portainer/portainer-ce:latest
```

- Access Portainer at **https://localhost:9443**
- Create admin account (minimum 12 character password)
- Select "Get Started" â†’ "local" environment

### Install N8N

```bash
# Run N8N container
docker run -d \
  --name n8n \
  --restart=always \
  -p 5678:5678 \
  -v n8n_data:/home/node/.n8n \
  -e GENERIC_TIMEZONE="America/Chicago" \
  -e TZ="America/Chicago" \
  n8nio/n8n
```

- Access N8N at **http://localhost:5678**
- Create local account
- This is a local instance, separate from any cloud N8N account

### Verify Installation

```bash
docker ps
# Should show: portainer, n8n
```

| Service | URL |
|---------|-----|
| Portainer | https://localhost:9443 |
| N8N | http://localhost:5678 |

---

## 1.7 Checkpoint

- MCP connects agents to data (Day 1)
- A2A connects agents to each other (Day 2)
- Portainer and N8N are running
- For deep protocol details, watch the A2A Deep Dive video on the portal

---

# Session 2: Building Your First A2A Agent
**Time:** 10:00 - 10:45 (45 minutes)

## Goals

- Build a Python A2A server wrapping our MES functionality
- Create an Agent Card describing capabilities and skills
- Implement A2A endpoints for task management
- Test the agent in the browser
- Use Claude Desktop to build a React visualization from the agent data

---

## Session Payoffs

### Payoff 1: Browser JSON Response

Open these URLs directly in the browser to see formatted JSON:
- `http://localhost:8001/.well-known/agent.json` â€” Agent Card
- `http://localhost:8001/a2a/skills/get_equipment_status` â€” Equipment data
- `http://localhost:8001/a2a/skills/get_oee_summary` â€” OEE metrics
- `http://localhost:8001/a2a/skills/get_downtime_summary` â€” Downtime analysis

### Payoff 2: Claude Desktop React Visualization

Give Claude Desktop a prompt to build a live dashboard from the A2A endpoints â€” demonstrating MCP + A2A working together.

---

## 2.1 Project Setup

- Create folder structure `day2/production_agent/`
- Create `requirements.txt` with dependencies
- Create Python virtual environment
- Install dependencies with pip
- Verify environment loads root `.env` file

### Folder Structure

```
day2/production_agent/
â”œâ”€â”€ README.md              # Build specification
â”œâ”€â”€ requirements.txt       # Dependencies
â””â”€â”€ src/
    â””â”€â”€ production_agent.py    # FastAPI application
```

### Dependencies

```
fastapi>=0.104.0
uvicorn>=0.24.0
paho-mqtt>=2.0.0
mysql-connector-python>=8.0.0
python-dotenv>=1.0.0
```

---

## 2.2 Understanding the Agent Card

- JSON metadata published at `/.well-known/agent.json`
- Describes identity (name, description, url, version)
- Declares capabilities (streaming, pushNotifications)
- Lists skills (id, name, description, inputModes, outputModes)
- Enables discovery by other agents and clients

### Agent Card Structure

```json
{
  "name": "Production Agent",
  "description": "Monitors Press 103 equipment status, OEE, and production metrics",
  "url": "http://localhost:8001",
  "version": "1.0.0",
  "capabilities": {
    "streaming": false,
    "pushNotifications": false
  },
  "skills": [
    {
      "id": "get_equipment_status",
      "name": "Get Equipment Status",
      "description": "Returns current running state, speed, and shift",
      "inputModes": ["text/plain"],
      "outputModes": ["application/json"]
    }
  ]
}
```

---

## 2.3 Building the FastAPI Application

- Create `src/production_agent.py`
- Set up FastAPI app with CORS middleware
- Create Pydantic models for A2A message/task structures
- Implement in-memory task storage (dict)
- Set up logging configuration

---

## 2.4 Implementing the Agent Card Endpoint

- Create GET `/.well-known/agent.json` route
- Return static Agent Card JSON
- Test with curl or browser

---

## 2.5 Implementing A2A Message Handling

- Create POST `/a2a/message/send` endpoint
- Parse incoming message and extract text
- Route to appropriate skill based on message content
- Generate unique task ID
- Execute skill and store result
- Return task with artifacts to caller

### Skill Routing Logic

| Keywords in Message | Skill |
|---------------------|-------|
| status, running, state, speed, shift | get_equipment_status |
| oee, performance, availability, quality | get_oee_summary |
| downtime, down, stopped, reason | get_downtime_summary |

---

## 2.6 Implementing Task Retrieval

- Create GET `/a2a/tasks/{task_id}` endpoint
- Look up task in storage
- Return task state and artifacts
- Handle task not found error

---

## 2.7 Implementing Direct Skill Endpoints

For browser-friendly testing, expose skills as simple GET endpoints:

- GET `/a2a/skills/get_equipment_status`
- GET `/a2a/skills/get_oee_summary`
- GET `/a2a/skills/get_downtime_summary`

These return skill results directly as JSON (not wrapped in task/artifacts).

---

## 2.8 Connecting to MES Data Sources

- Copy MQTT client wrapper from Day 1
- Copy MySQL connection pool from Day 1
- Implement `get_equipment_status()` function
- Implement `get_oee_summary()` function
- Implement `get_downtime_summary()` function
- Initialize connections on startup

---

## 2.9 Testing the Production Agent

### Start the Server

```bash
cd day2/production_agent
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python src/production_agent.py
```

### Test in Browser (Payoff 1)

Open these URLs:
- http://localhost:8001/.well-known/agent.json
- http://localhost:8001/a2a/skills/get_equipment_status
- http://localhost:8001/a2a/skills/get_oee_summary
- http://localhost:8001/a2a/skills/get_downtime_summary

### Test with curl

```bash
# Agent Card
curl http://localhost:8001/.well-known/agent.json | jq

# Direct skill access
curl http://localhost:8001/a2a/skills/get_oee_summary | jq

# A2A message send
curl -X POST http://localhost:8001/a2a/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "message": {
      "role": "user",
      "parts": [{"type": "text", "text": "What is the current OEE?"}]
    }
  }' | jq
```

---

## 2.10 Claude Desktop Visualization (Payoff 2)

With the Production Agent running, give Claude Desktop this prompt:

```
I have an A2A Production Agent running locally that provides manufacturing data for Press 103.

The agent exposes these endpoints:
- http://localhost:8001/a2a/skills/get_equipment_status
- http://localhost:8001/a2a/skills/get_oee_summary
- http://localhost:8001/a2a/skills/get_downtime_summary

Create a React artifact that:

1. Fetches data from all three endpoints on load and when a "Refresh" button is clicked

2. Displays an Equipment Status card showing:
   - Running/Stopped indicator (green/red)
   - Current state code
   - Speed vs Setpoint with percentage
   - Current shift

3. Displays OEE metrics:
   - Overall OEE as a large number with rating
   - Three progress bars for Availability, Performance, Quality
   - Good count and bad count

4. Displays Downtime Summary:
   - Current state
   - Total downtime in hours
   - Planned vs Unplanned breakdown

Use a dark industrial theme with:
- Dark gray background (#1a1a2e)
- Card backgrounds (#16213e)
- Accent colors: green for good, red for bad, blue for info

Add error handling for failed fetches and show a loading state.
```

**Takeaway:** Claude uses MCP to execute code, and the code consumes A2A agent data â€” MCP + A2A working together.

---

## 2.11 Checkpoint

- We have a working A2A agent wrapping our MES functionality
- Agent Card describes capabilities for discovery
- Browser can access skill endpoints directly
- Claude Desktop can build visualizations from A2A data
- Ready to orchestrate with N8N

---

# Session 3: Multi-Agent Workflows with N8N
**Time:** 11:00 - 11:45 (45 minutes)

## Goals

- Connect N8N to our agents via HTTP
- Build an orchestrated workflow for a production scenario
- Demonstrate how orchestration simplifies multi-agent coordination
- Discuss monitoring, debugging, and production considerations

---

## 3.1 N8N Quick Orientation

- Open N8N at http://localhost:5678
- Review the interface (canvas, nodes panel, execution)
- Explain trigger types (manual, webhook, schedule)
- Explain HTTP Request node basics
- Explain Code node for JavaScript processing

---

## 3.2 Exercise 1 â€” Import the Shift Status Workflow

- Open the import dialog (â‹® menu â†’ Import from File)
- Import `n8n_shift_status_workflow.json` from `day2/n8n_integration/`
- Review each node in the workflow
- Trace the data flow visually
- Click Test Workflow
- Verify observation posted to UNS

### Workflow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Manual   â”‚â”€â”€â–¶â”‚   Get    â”‚â”€â”€â–¶â”‚   Get    â”‚â”€â”€â–¶â”‚   Get    â”‚â”€â”€â–¶â”‚  Build   â”‚â”€â”€â–¶â”‚   Post   â”‚
â”‚ Trigger  â”‚   â”‚  Status  â”‚   â”‚   OEE    â”‚   â”‚Work Orderâ”‚   â”‚ Message  â”‚   â”‚Observationâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3.3 Understanding the Workflow Nodes

- Walk through Manual Trigger node
- Walk through Get Equipment Status node (HTTP GET)
- Walk through Get OEE node (HTTP GET)
- Walk through Get Work Order node (HTTP GET)
- Walk through Build Observation node (JavaScript code)
- Walk through Post Observation node (HTTP POST)

### Key: N8N to Localhost

Since N8N runs in Docker, use `host.docker.internal` to reach localhost:

```
http://host.docker.internal:8001/equipment/status
```

---

## 3.4 Exercise 2 â€” Adding Decision Logic

- Explain the scenario (different alerts based on OEE)
- Add a Switch node after Get OEE
- Configure condition: `availability < 0.5`
- Create "Low Availability" branch
- Create "Normal" branch
- Build different messages for each branch
- Merge branches back to Post Observation

### Updated Workflow

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”Œâ”€â”€â”€â–¶â”‚ Low Avail.   â”‚â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚    â”‚ Message      â”‚   â”‚
â”‚ Get Data â”‚â”€â”€â–¶â”‚Switchâ”‚â”€â”€â”¤    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚   â”‚      â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”œâ”€â”€â”€â–¶â”‚   Post   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜  â”œâ”€â”€â”€â–¶â”‚ Normal       â”‚â”€â”€â”€â”¤    â”‚Observationâ”‚
                         â”‚    â”‚ Message      â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
```

---

## 3.5 Testing the Enhanced Workflow

- Run the workflow with current data
- Observe which branch executes
- View the posted observation message
- Discuss how thresholds could be configured

---

## 3.6 Debugging Techniques

- Show N8N execution history
- Click into a past execution
- Examine input/output at each node
- Show error state highlighting
- Demonstrate testing a single node

### Common Issues

| Issue | Solution |
|-------|----------|
| Connection refused | Check agent is running, correct port |
| Timeout | Increase N8N timeout, check agent performance |
| Invalid JSON | Validate response format, check Content-Type |
| Empty response | Check agent logs, verify data sources |

---

## 3.7 Extending the Workflow (Discussion)

- Adding scheduled triggers (run every hour)
- Adding webhook triggers (external systems call N8N)
- Parallel execution (fetch all data simultaneously)
- Error handling branches
- Sending alerts to Slack/email

---

## 3.8 Production Considerations

- **Deployment** â€” containers, cloud, edge devices
- **Security** â€” API keys, JWT between agents
- **Scaling** â€” stateless agents, load balancing
- **Persistence** â€” task storage, recovery
- **Human-in-the-loop** â€” approval workflows, escalation

---

## 3.9 Wrap-Up and Next Steps

- Recap Day 2 accomplishments
- Remind about A2A Deep Dive video on portal
- Suggest experimentation ideas
- Q&A

### What We Built Today

âœ… Reviewed Day 1 MCP architecture  
âœ… Learned A2A protocol fundamentals  
âœ… Installed Portainer and N8N  
âœ… Built A2A Production Agent  
âœ… Tested agent in browser and with Claude Desktop  
âœ… Orchestrated workflows with N8N  

---

## Files Reference

```
day2/
â”œâ”€â”€ DAY2_LESSON_PLAN.md           # This file
â”œâ”€â”€ setup/
â”‚   â””â”€â”€ README.md                 # Detailed Docker/Portainer/N8N setup
â”‚
â”œâ”€â”€ production_agent/             # Session 2
â”‚   â”œâ”€â”€ README.md                 # Build specification for Cursor
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ production_agent.py
â”‚
â””â”€â”€ n8n_integration/              # Session 3
    â”œâ”€â”€ README.md
    â”œâ”€â”€ requirements.txt
    â”œâ”€â”€ mes_http_server.py
    â””â”€â”€ n8n_shift_status_workflow.json
```

---

## Quick Reference

### URLs

| Service | URL |
|---------|-----|
| N8N | http://localhost:5678 |
| Portainer | https://localhost:9443 |
| Production Agent | http://localhost:8001 |
| MES HTTP Server | http://localhost:8001 |

### From N8N (Docker)

Use `host.docker.internal` instead of `localhost`:
```
http://host.docker.internal:8001/a2a/skills/get_oee_summary
```

### Key Commands

```bash
# Check Docker containers
docker ps

# Start Production Agent
cd day2/production_agent
source venv/bin/activate
python src/production_agent.py

# Start MES HTTP Server (alternative for Session 3)
cd day2/n8n_integration
source venv/bin/activate
python mes_http_server.py
```
